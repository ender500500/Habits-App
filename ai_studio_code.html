<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <title>Habits</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Habits">
    
    <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAgMTAwIj48cmVjdCB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgZmlsbD0iIzA5MDUxNCIvPjxwYXRoIGQ9Ik0yNSA1MCBsMTUgMTUgbDM1IC0zNSIgc3Ryb2tlPSIjZmZmZmZmIiBzdHJva2Utd2lkdGg9IjgiIGZpbGw9Im5vbmUiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCIvPjwvc3ZnPg==">

    <script src="https://cdn.tailwindcss.com"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        appBg: '#090514',       
                        cardBg: '#170b33',      
                        primary: '#9d4edd',     
                        textMain: '#f3e8ff',    
                        textMuted: '#a78bfa'    
                    }
                }
            }
        }
    </script>
    <style>
        body { -webkit-user-select: none; user-select: none; }
        .transition-transform { transition-property: transform; transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1); transition-duration: 300ms; }
        .check-transition { transition: all 0.2s ease-in-out; }
        ::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="bg-appBg text-textMain font-sans min-h-screen relative pb-20 overflow-x-hidden">

    <!-- Header -->
    <header class="pt-12 pb-6 px-6 sticky top-0 bg-appBg/90 backdrop-blur-md z-10 flex justify-between items-center">
        <h1 class="text-3xl font-bold tracking-tight">Habits</h1>
        <button onclick="openModal('settings-modal')" class="p-2 text-textMuted hover:text-white transition-colors">
            <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
            </svg>
        </button>
    </header>

    <!-- Habit List -->
    <main class="px-6 space-y-4" id="habit-list"></main>

    <!-- Floating Add Button -->
    <button id="fab-add" onclick="openModal('add-modal')" class="fixed bottom-8 right-6 bg-primary text-white w-14 h-14 rounded-full shadow-[0_4px_20px_rgba(157,78,221,0.5)] flex items-center justify-center hover:scale-105 active:scale-95 transition-transform z-20">
        <svg class="w-8 h-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
        </svg>
    </button>

    <!-- Dark Overlay -->
    <div id="modal-overlay" onclick="closeAllModals()" class="fixed inset-0 bg-black/80 z-30 hidden transition-opacity"></div>

    <!-- Add Habit Menu -->
    <div id="add-modal" class="fixed bottom-0 left-0 right-0 bg-cardBg rounded-t-3xl z-40 transform translate-y-full transition-transform p-6 border-t border-primary/30 shadow-[0_-10px_40px_rgba(157,78,221,0.15)] max-h-[90vh] overflow-y-auto">
        <div class="w-12 h-1.5 bg-textMuted/30 rounded-full mx-auto mb-6"></div>
        <h2 class="text-xl font-bold mb-4">New Habit</h2>
        
        <input type="text" id="habit-name" placeholder="Habit Name (e.g., Drink Water)" class="w-full bg-appBg text-textMain border border-primary/30 rounded-xl p-4 mb-4 focus:outline-none focus:border-primary placeholder-textMuted/50">
        <textarea id="habit-desc" placeholder="Description or 'Why' (Optional)" rows="2" class="w-full bg-appBg text-textMain border border-primary/30 rounded-xl p-4 mb-4 focus:outline-none focus:border-primary placeholder-textMuted/50"></textarea>
        
        <div class="bg-appBg border border-primary/30 rounded-xl p-4 mb-6">
            <label class="block text-sm text-textMuted mb-2">Daily Target Number (Optional)</label>
            <input type="number" id="habit-target" placeholder="e.g. 8 (glasses), 30 (g fiber)" class="w-full bg-transparent text-textMain focus:outline-none placeholder-textMuted/50 text-lg">
        </div>
        
        <div class="flex gap-4">
            <button onclick="closeAllModals()" class="flex-1 py-4 rounded-xl font-semibold text-textMuted bg-appBg border border-primary/20 active:bg-primary/10">Cancel</button>
            <button onclick="addHabit()" class="flex-1 py-4 rounded-xl font-semibold text-white bg-primary active:bg-primary/80">Save</button>
        </div>
    </div>

    <!-- Settings Menu -->
    <div id="settings-modal" class="fixed bottom-0 left-0 right-0 bg-cardBg rounded-t-3xl z-40 transform translate-y-full transition-transform p-6 border-t border-primary/30 shadow-[0_-10px_40px_rgba(157,78,221,0.15)]">
        <div class="w-12 h-1.5 bg-textMuted/30 rounded-full mx-auto mb-6"></div>
        <h2 class="text-xl font-bold mb-6">Settings & Backup</h2>
        
        <div class="space-y-4 mb-6">
            <button onclick="exportData()" class="w-full py-4 rounded-xl font-semibold text-white bg-appBg border border-primary/40 flex items-center justify-center gap-2 active:bg-primary/20">
                <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
                Export Data (Backup)
            </button>
            
            <label class="w-full py-4 rounded-xl font-semibold text-white bg-appBg border border-primary/40 flex items-center justify-center gap-2 active:bg-primary/20 cursor-pointer">
                <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" /></svg>
                Import Data (Restore)
                <input type="file" id="import-file" class="hidden" accept=".json" onchange="importData(event)">
            </label>
        </div>
        
        <button onclick="closeAllModals()" class="w-full py-4 rounded-xl font-semibold text-textMuted bg-appBg border border-primary/20 active:bg-primary/10">Close</button>
    </div>

    <!-- Stats & Calendar Menu -->
    <div id="stats-modal" class="fixed bottom-0 left-0 right-0 bg-cardBg rounded-t-3xl z-40 transform translate-y-full transition-transform p-6 border-t border-primary/30 shadow-[0_-10px_40px_rgba(157,78,221,0.15)] max-h-[90vh] overflow-y-auto">
        <div class="w-12 h-1.5 bg-textMuted/30 rounded-full mx-auto mb-6"></div>
        <div id="stats-content">
            <!-- Injected by JS -->
        </div>
        <button onclick="closeAllModals()" class="w-full mt-6 py-4 rounded-xl font-semibold text-white bg-primary active:bg-primary/80">Close</button>
    </div>

    <!-- JavaScript Logic -->
    <script>
        let habits = JSON.parse(localStorage.getItem('my_habits')) || [];
        
        // Calendar State Variables
        let currentViewedHabitId = null;
        let currentMonth = new Date().getMonth();
        let currentYear = new Date().getFullYear();

        function getTodayString() {
            const d = new Date();
            return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
        }

        function saveHabits() {
            localStorage.setItem('my_habits', JSON.stringify(habits));
        }

        // --- Data Backup (Export/Import) ---
        function exportData() {
            const dataStr = JSON.stringify(habits);
            const blob = new Blob([dataStr], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `habits-backup-${getTodayString()}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedHabits = JSON.parse(e.target.result);
                    if (Array.isArray(importedHabits)) {
                        habits = importedHabits;
                        saveHabits();
                        renderHabits();
                        closeAllModals();
                        alert("Data restored successfully!");
                    } else {
                        alert("Invalid backup file.");
                    }
                } catch (err) {
                    alert("Error reading file.");
                }
            };
            reader.readAsText(file);
            event.target.value = ''; // Reset input
        }

        // --- Advanced Stats Calculations ---
        function getStreak(history) {
            if (!history || history.length === 0) return 0;
            let streak = 0;
            let d = new Date();
            let dateStr = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
            
            if (history.includes(dateStr)) {
                streak++;
                d.setDate(d.getDate() - 1);
            } else {
                d.setDate(d.getDate() - 1);
                dateStr = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
                if (!history.includes(dateStr)) return 0;
            }
            
            while(true) {
                dateStr = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
                if (history.includes(dateStr)) {
                    streak++;
                    d.setDate(d.getDate() - 1);
                } else {
                    break;
                }
            }
            return streak;
        }

        function getLongestStreak(history) {
            if (!history || history.length === 0) return 0;
            const sorted = [...history].sort();
            let max = 1;
            let current = 1;
            for (let i = 1; i < sorted.length; i++) {
                const d1 = new Date(sorted[i-1]);
                const d2 = new Date(sorted[i]);
                const diffTime = Math.abs(d2 - d1);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                if (diffDays === 1) {
                    current++;
                    max = Math.max(max, current);
                } else if (diffDays > 1) {
                    current = 1;
                }
            }
            return max;
        }

        function checkDailyResets() {
            const today = getTodayString();
            let changed = false;
            habits.forEach(habit => {
                if (!habit.history) habit.history = []; 
                if (habit.lastUpdated !== today) {
                    habit.progress = 0;
                    habit.lastUpdated = today;
                    changed = true;
                }
            });
            if (changed) saveHabits();
        }

        function renderHabits() {
            checkDailyResets();
            const habitList = document.getElementById('habit-list');
            habitList.innerHTML = ''; 
            const today = getTodayString();

            if (habits.length === 0) {
                habitList.innerHTML = '<p class="text-textMuted text-center mt-10">No habits yet. Tap + to add one!</p>';
                return;
            }

            habits.forEach(habit => {
                const isCounter = habit.type === 'counter';
                const isDone = habit.history.includes(today);
                const streak = getStreak(habit.history);
                
                let circleContent = '';
                if (isDone) {
                    circleContent = `<svg class="w-6 h-6 text-white check-transition" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" /></svg>`;
                } else if (isCounter) {
                    circleContent = `<span class="text-sm font-bold">${habit.progress}<span class="text-[10px] text-textMuted/80">/${habit.target}</span></span>`;
                } else {
                    circleContent = `<svg class="w-6 h-6 text-primary opacity-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" /></svg>`;
                }

                const habitEl = document.createElement('div');
                habitEl.className = `bg-cardBg p-4 rounded-2xl shadow-lg border ${isDone ? 'border-primary' : 'border-primary/20'} flex items-center gap-4 check-transition relative overflow-hidden`;
                
                let progressBg = '';
                if (isCounter && !isDone && habit.progress > 0) {
                    const percent = (habit.progress / habit.target) * 100;
                    progressBg = `<div class="absolute left-0 bottom-0 h-1 bg-primary/40 transition-all" style="width: ${percent}%"></div>`;
                }

                habitEl.innerHTML = `
                    ${progressBg}
                    <button onclick="interactHabit('${habit.id}')" class="w-12 h-12 rounded-full border-2 border-primary flex-shrink-0 flex items-center justify-center check-transition z-10 ${isDone ? 'bg-primary' : 'bg-transparent text-primary'} active:scale-90">
                        ${circleContent}
                    </button>
                    
                    <div class="flex-1 z-10 py-1 cursor-pointer" onclick="openStats('${habit.id}')">
                        <div class="flex items-center gap-2">
                            <h2 class="text-lg font-semibold ${isDone ? 'text-textMuted line-through' : 'text-textMain'} check-transition">${habit.name}</h2>
                            ${streak > 0 ? `<span class="text-xs font-bold text-orange-400 bg-orange-400/10 px-2 py-0.5 rounded-full">ðŸ”¥ ${streak}</span>` : ''}
                        </div>
                        ${habit.desc ? `<p class="text-textMuted text-sm leading-snug ${isDone ? 'opacity-50' : ''} mt-0.5">${habit.desc}</p>` : ''}
                    </div>
                    
                    <button onclick="deleteHabit('${habit.id}')" class="text-textMuted hover:text-red-400 p-2 z-10 active:scale-90 transition-transform flex-shrink-0">
                        <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                    </button>
                `;
                document.getElementById('habit-list').appendChild(habitEl);
            });
        }

        function addHabit() {
            const name = document.getElementById('habit-name').value.trim();
            const desc = document.getElementById('habit-desc').value.trim();
            const targetVal = document.getElementById('habit-target').value.trim();
            
            if (!name) return; 

            const isCounter = targetVal !== '' && !isNaN(targetVal) && Number(targetVal) > 0;

            habits.push({
                id: Date.now().toString(),
                name: name,
                desc: desc,
                type: isCounter ? 'counter' : 'boolean',
                target: isCounter ? Number(targetVal) : null,
                progress: 0,
                history: [], 
                lastUpdated: getTodayString(),
                createdAt: getTodayString()
            });

            saveHabits();
            renderHabits();
            closeAllModals();
            
            document.getElementById('habit-name').value = '';
            document.getElementById('habit-desc').value = '';
            document.getElementById('habit-target').value = '';
        }

        function deleteHabit(id) {
            if(confirm("Delete this habit?")) {
                habits = habits.filter(h => h.id !== id);
                saveHabits();
                renderHabits();
            }
        }

        function interactHabit(id) {
            const today = getTodayString();
            const habit = habits.find(h => h.id === id);
            const isDone = habit.history.includes(today);
            
            if (habit.type === 'boolean') {
                if (isDone) habit.history = habit.history.filter(d => d !== today);
                else habit.history.push(today);
            } else if (habit.type === 'counter') {
                if (!isDone) {
                    habit.progress += 1;
                    if (habit.progress >= habit.target) habit.history.push(today);
                } else {
                    habit.progress = 0;
                    habit.history = habit.history.filter(d => d !== today);
                }
            }
            
            habit.lastUpdated = today;
            saveHabits();
            renderHabits();
        }

        // --- Calendar & Stats Rendering ---
        function changeMonth(offset) {
            currentMonth += offset;
            if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            } else if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            }
            renderStatsContent();
        }

        function openStats(id) {
            currentViewedHabitId = id;
            currentMonth = new Date().getMonth();
            currentYear = new Date().getFullYear();
            renderStatsContent();
            openModal('stats-modal');
        }

        function renderStatsContent() {
            const habit = habits.find(h => h.id === currentViewedHabitId);
            if (!habit) return;

            const content = document.getElementById('stats-content');
            const streak = getStreak(habit.history);
            const longestStreak = getLongestStreak(habit.history);
            
            // 7-Day Chart Generation
            let chartHtml = '<div class="flex justify-between items-end h-20 mt-4 gap-2">';
            for(let i=6; i>=0; i--) {
                let d = new Date();
                d.setDate(d.getDate() - i);
                let dStr = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
                let isDone = habit.history.includes(dStr);
                let hClass = isDone ? 'h-full bg-primary shadow-[0_0_10px_rgba(157,78,221,0.5)]' : 'h-1/4 bg-primary/20';
                let dayName = d.toLocaleDateString('en-US', {weekday: 'narrow'});
                chartHtml += `<div class="flex flex-col items-center flex-1 gap-2"><div class="w-full rounded-md ${hClass} transition-all"></div><span class="text-xs font-bold text-textMuted">${dayName}</span></div>`;
            }
            chartHtml += '</div>';

            // Calendar Generation
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            const firstDay = new Date(currentYear, currentMonth, 1).getDay();
            const monthDate = new Date(currentYear, currentMonth);
            const monthName = monthDate.toLocaleString('default', { month: 'long' });

            let calHtml = `
                <div class="flex justify-between items-center mb-4">
                    <button onclick="changeMonth(-1)" class="p-2 text-primary hover:bg-primary/10 rounded-lg">&larr;</button>
                    <h3 class="font-bold text-textMain">${monthName} ${currentYear}</h3>
                    <button onclick="changeMonth(1)" class="p-2 text-primary hover:bg-primary/10 rounded-lg">&rarr;</button>
                </div>
            `;
            calHtml += `<div class="grid grid-cols-7 gap-2 text-center text-xs mb-2">`;
            ['S', 'M', 'T', 'W', 'T', 'F', 'S'].forEach(d => calHtml += `<div class="text-textMuted/70 font-bold">${d}</div>`);
            calHtml += `</div><div class="grid grid-cols-7 gap-2">`;

            for (let i = 0; i < firstDay; i++) calHtml += `<div></div>`;

            for (let i = 1; i <= daysInMonth; i++) {
                const dateStr = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
                const isDone = habit.history.includes(dateStr);
                const isToday = dateStr === getTodayString();
                
                let bgClass = 'bg-appBg border border-primary/10 text-textMuted/50';
                if (isDone) bgClass = 'bg-primary text-white shadow-[0_0_10px_rgba(157,78,221,0.4)] font-bold';
                else if (isToday) bgClass = 'bg-appBg border border-primary text-textMain font-bold';

                calHtml += `<div class="aspect-square rounded-lg flex items-center justify-center ${bgClass}">${i}</div>`;
            }
            calHtml += `</div>`;

            content.innerHTML = `
                <h2 class="text-2xl font-bold mb-1">${habit.name}</h2>
                <p class="text-textMuted mb-6">${habit.history.length} Total Completions</p>
                
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div class="bg-appBg rounded-2xl p-4 border border-primary/20 text-center">
                        <div class="text-2xl mb-1">ðŸ”¥</div>
                        <div class="text-2xl font-bold text-textMain">${streak}</div>
                        <div class="text-xs text-textMuted uppercase tracking-wider mt-1">Current Streak</div>
                    </div>
                    <div class="bg-appBg rounded-2xl p-4 border border-primary/20 text-center">
                        <div class="text-2xl mb-1">ðŸ‘‘</div>
                        <div class="text-2xl font-bold text-textMain">${longestStreak}</div>
                        <div class="text-xs text-textMuted uppercase tracking-wider mt-1">Best Streak</div>
                    </div>
                </div>

                <div class="bg-appBg rounded-2xl p-4 border border-primary/20 mb-6">
                    <h3 class="text-xs text-textMuted uppercase tracking-wider font-bold mb-2">Last 7 Days</h3>
                    ${chartHtml}
                </div>
                
                <div class="bg-appBg rounded-2xl p-4 border border-primary/20">
                    ${calHtml}
                </div>
            `;
        }

        // --- Modal Controls ---
        function openModal(modalId) {
            document.getElementById('modal-overlay').classList.remove('hidden');
            setTimeout(() => document.getElementById(modalId).classList.remove('translate-y-full'), 10);
        }

        function closeAllModals() {
            document.getElementById('add-modal').classList.add('translate-y-full');
            document.getElementById('stats-modal').classList.add('translate-y-full');
            document.getElementById('settings-modal').classList.add('translate-y-full');
            setTimeout(() => document.getElementById('modal-overlay').classList.add('hidden'), 300);
        }

        renderHabits();
    </script>
</body>
</html>
