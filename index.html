<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <title>Habits</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Habits">
    
    <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAgMTAwIj48cmVjdCB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgZmlsbD0iIzA5MDUxNCIvPjxwYXRoIGQ9Ik0yNSA1MCBsMTUgMTUgbDM1IC0zNSIgc3Ryb2tlPSIjZmZmZmZmIiBzdHJva2Utd2lkdGg9IjgiIGZpbGw9Im5vbmUiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCIvPjwvc3ZnPg==">

    <script src="https://cdn.tailwindcss.com"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        appBg: '#090514',       
                        cardBg: '#170b33',      
                        primary: '#9d4edd',     
                        textMain: '#f3e8ff',    
                        textMuted: '#a78bfa'    
                    }
                }
            }
        }
    </script>
    <style>
        body { -webkit-user-select: none; user-select: none; -webkit-tap-highlight-color: transparent; }
        .transition-transform { transition-property: transform; transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1); transition-duration: 300ms; }
        .check-transition { transition: all 0.2s ease-in-out; }
        ::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="bg-appBg text-textMain font-sans min-h-screen relative pb-24 overflow-x-hidden">

    <!-- Header -->
    <header class="pt-12 pb-6 px-6 sticky top-0 bg-appBg/90 backdrop-blur-md z-10 flex justify-between items-center">
        <h1 class="text-3xl font-bold tracking-tight">Habits</h1>
        <button onclick="openModal('settings-modal')" class="p-2 text-textMuted hover:text-white transition-colors">
            <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
            </svg>
        </button>
    </header>

    <!-- Habit List -->
    <main class="px-6 space-y-4" id="habit-list"></main>

    <!-- Floating Add Button -->
    <button id="fab-add" onclick="prepareAddModal()" class="fixed bottom-8 right-6 bg-primary text-white w-14 h-14 rounded-full shadow-[0_4px_20px_rgba(157,78,221,0.5)] flex items-center justify-center hover:scale-105 active:scale-95 transition-transform z-20">
        <svg class="w-8 h-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
        </svg>
    </button>

    <!-- Dark Overlay -->
    <div id="modal-overlay" onclick="closeAllModals()" class="fixed inset-0 bg-black/80 z-30 hidden transition-opacity"></div>

    <!-- Add/Edit Habit Menu -->
    <div id="habit-modal" class="fixed bottom-0 left-0 right-0 bg-cardBg rounded-t-3xl z-40 transform translate-y-full transition-transform p-6 border-t border-primary/30 shadow-[0_-10px_40px_rgba(157,78,221,0.15)] max-h-[90vh] overflow-y-auto">
        <div class="w-12 h-1.5 bg-textMuted/30 rounded-full mx-auto mb-6"></div>
        <h2 id="modal-title" class="text-xl font-bold mb-4 text-primary">New Habit</h2>
        
        <input type="hidden" id="edit-id">
        <input type="text" id="habit-name" placeholder="Habit Name (e.g., Drink Water)" class="w-full bg-appBg text-textMain border border-primary/30 rounded-xl p-4 mb-4 focus:outline-none focus:border-primary placeholder-textMuted/50">
        <textarea id="habit-desc" placeholder="Description or 'Why' (Keep it long if you want!)" rows="3" class="w-full bg-appBg text-textMain border border-primary/30 rounded-xl p-4 mb-4 focus:outline-none focus:border-primary placeholder-textMuted/50"></textarea>
        
        <div class="bg-appBg border border-primary/30 rounded-xl p-4 mb-6">
            <label class="block text-sm text-textMuted mb-2">Daily Target Number (e.g. 8 for 8 glasses)</label>
            <input type="number" id="habit-target" placeholder="Leave empty for yes/no habit" class="w-full bg-transparent text-textMain focus:outline-none placeholder-textMuted/50 text-lg">
        </div>
        
        <div class="flex gap-4">
            <button onclick="closeAllModals()" class="flex-1 py-4 rounded-xl font-semibold text-textMuted bg-appBg border border-primary/20">Cancel</button>
            <button onclick="saveHabitAction()" class="flex-1 py-4 rounded-xl font-semibold text-white bg-primary">Save Habit</button>
        </div>
    </div>

    <!-- Settings Menu -->
    <div id="settings-modal" class="fixed bottom-0 left-0 right-0 bg-cardBg rounded-t-3xl z-40 transform translate-y-full transition-transform p-6 border-t border-primary/30 shadow-[0_-10px_40px_rgba(157,78,221,0.15)]">
        <div class="w-12 h-1.5 bg-textMuted/30 rounded-full mx-auto mb-6"></div>
        <h2 class="text-xl font-bold mb-6">Settings & Backup</h2>
        
        <div class="space-y-4 mb-6">
            <button onclick="exportData()" class="w-full py-4 rounded-xl font-semibold text-white bg-appBg border border-primary/40 flex items-center justify-center gap-2">
                <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
                Export Data (Backup)
            </button>
            
            <label class="w-full py-4 rounded-xl font-semibold text-white bg-appBg border border-primary/40 flex items-center justify-center gap-2 cursor-pointer">
                <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" /></svg>
                Import Data (Restore)
                <input type="file" id="import-file" class="hidden" accept=".json" onchange="importData(event)">
            </label>
        </div>
        <button onclick="closeAllModals()" class="w-full py-4 rounded-xl font-semibold text-textMuted bg-appBg border border-primary/20">Close</button>
    </div>

    <!-- Stats & Description Menu -->
    <div id="stats-modal" class="fixed bottom-0 left-0 right-0 bg-cardBg rounded-t-3xl z-40 transform translate-y-full transition-transform p-6 border-t border-primary/30 shadow-[0_-10px_40px_rgba(157,78,221,0.15)] max-h-[90vh] overflow-y-auto">
        <div class="w-12 h-1.5 bg-textMuted/30 rounded-full mx-auto mb-6"></div>
        <div id="stats-content"></div>
        <button onclick="closeAllModals()" class="w-full mt-6 py-4 rounded-xl font-semibold text-white bg-primary">Close</button>
    </div>

    <script>
        let habits = JSON.parse(localStorage.getItem('my_habits')) || [];
        let currentMonth = new Date().getMonth();
        let currentYear = new Date().getFullYear();
        let currentViewedHabitId = null;

        function getTodayString() {
            const d = new Date();
            return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
        }

        function saveToStorage() {
            localStorage.setItem('my_habits', JSON.stringify(habits));
        }

        function exportData() {
            const dataStr = JSON.stringify(habits);
            const blob = new Blob([dataStr], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `habits-backup-${getTodayString()}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const imported = JSON.parse(e.target.result);
                    if (Array.isArray(imported)) {
                        habits = imported;
                        saveToStorage();
                        renderHabits();
                        closeAllModals();
                    }
                } catch (err) { alert("Invalid file."); }
            };
            reader.readAsText(file);
        }

        // --- Core Rendering ---
        function renderHabits() {
            const list = document.getElementById('habit-list');
            list.innerHTML = '';
            const today = getTodayString();

            if (habits.length === 0) {
                list.innerHTML = '<p class="text-textMuted text-center mt-10 opacity-50">No habits yet. Tap + to start!</p>';
                return;
            }

            habits.forEach(habit => {
                if (habit.lastUpdated !== today) {
                    habit.progress = 0;
                    habit.lastUpdated = today;
                }

                const isDone = habit.history.includes(today);
                const streak = getStreak(habit.history);
                const isCounter = habit.type === 'counter';

                // CHECKMARK OR 1/3 UI
                let circleContent = '';
                if (isDone) {
                    circleContent = `<svg class="w-6 h-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" /></svg>`;
                } else if (isCounter) {
                    circleContent = `
                        <div class="flex flex-col items-center justify-center leading-none">
                            <span class="text-sm font-bold">${habit.progress}</span>
                            <div class="w-4 h-[1px] bg-primary/40 my-0.5"></div>
                            <span class="text-[10px] opacity-60">${habit.target}</span>
                        </div>
                    `;
                }

                const habitEl = document.createElement('div');
                habitEl.className = `bg-cardBg p-4 rounded-2xl border ${isDone ? 'border-primary' : 'border-primary/20'} flex items-center gap-4 relative overflow-hidden transition-all`;
                
                let progressPercent = isCounter ? (habit.progress / habit.target) * 100 : 0;

                habitEl.innerHTML = `
                    ${isCounter && !isDone ? `<div class="absolute left-0 bottom-0 h-1 bg-primary/40 transition-all" style="width: ${progressPercent}%"></div>` : ''}
                    
                    <button onclick="interactHabit('${habit.id}')" class="w-12 h-12 rounded-full border-2 border-primary flex-shrink-0 flex items-center justify-center ${isDone ? 'bg-primary' : ''} active:scale-90 transition-all">
                        ${circleContent}
                    </button>
                    
                    <div class="flex-1 min-w-0" onclick="openStats('${habit.id}')">
                        <div class="flex items-center gap-2">
                            <h2 class="font-bold truncate ${isDone ? 'text-textMuted line-through' : ''}">${habit.name}</h2>
                            ${streak > 0 ? `<span class="text-[10px] font-bold text-orange-400 bg-orange-400/10 px-2 py-0.5 rounded-full">üî• ${streak}</span>` : ''}
                        </div>
                        <p class="text-xs text-textMuted truncate">${habit.desc || 'Tap for details'}</p>
                    </div>
                    
                    <div class="flex gap-1">
                        <button onclick="prepareEditModal('${habit.id}')" class="p-2 text-textMuted/40 hover:text-primary active:scale-90 transition-all">
                            <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>
                        </button>
                    </div>
                `;
                list.appendChild(habitEl);
            });
            saveToStorage();
        }

        // --- Modals Logic ---
        function prepareAddModal() {
            document.getElementById('modal-title').innerText = "New Habit";
            document.getElementById('edit-id').value = "";
            document.getElementById('habit-name').value = "";
            document.getElementById('habit-desc').value = "";
            document.getElementById('habit-target').value = "";
            openModal('habit-modal');
        }

        function prepareEditModal(id) {
            const habit = habits.find(h => h.id === id);
            if (!habit) return;
            document.getElementById('modal-title').innerText = "Edit Habit";
            document.getElementById('edit-id').value = habit.id;
            document.getElementById('habit-name').value = habit.name;
            document.getElementById('habit-desc').value = habit.desc;
            document.getElementById('habit-target').value = habit.target || "";
            openModal('habit-modal');
        }

        function saveHabitAction() {
            const id = document.getElementById('edit-id').value;
            const name = document.getElementById('habit-name').value.trim();
            const desc = document.getElementById('habit-desc').value.trim();
            const targetVal = document.getElementById('habit-target').value;
            
            if (!name) return;
            const isCounter = targetVal !== '' && !isNaN(targetVal) && Number(targetVal) > 0;

            if (id) {
                const idx = habits.findIndex(h => h.id === id);
                habits[idx].name = name;
                habits[idx].desc = desc;
                habits[idx].type = isCounter ? 'counter' : 'boolean';
                habits[idx].target = isCounter ? Number(targetVal) : null;
            } else {
                habits.push({
                    id: Date.now().toString(),
                    name, desc,
                    type: isCounter ? 'counter' : 'boolean',
                    target: isCounter ? Number(targetVal) : null,
                    progress: 0, history: [], lastUpdated: getTodayString()
                });
            }
            renderHabits();
            closeAllModals();
        }

        function interactHabit(id) {
            const habit = habits.find(h => h.id === id);
            const today = getTodayString();
            const isDone = habit.history.includes(today);

            if (habit.type === 'boolean') {
                if (isDone) habit.history = habit.history.filter(d => d !== today);
                else habit.history.push(today);
            } else {
                if (!isDone) {
                    habit.progress++;
                    if (habit.progress >= habit.target) habit.history.push(today);
                } else {
                    habit.progress = 0;
                    habit.history = habit.history.filter(d => d !== today);
                }
            }
            renderHabits();
        }

        // --- Stats & Detail View ---
        function openStats(id) {
            currentViewedHabitId = id;
            renderStatsContent();
            openModal('stats-modal');
        }

        function renderStatsContent() {
            const habit = habits.find(h => h.id === currentViewedHabitId);
            const content = document.getElementById('stats-content');
            
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            const firstDay = new Date(currentYear, currentMonth, 1).getDay();
            const monthName = new Date(currentYear, currentMonth).toLocaleString('default', { month: 'long' });

            let calHtml = `<div class="grid grid-cols-7 gap-1 text-center text-[10px] text-textMuted mb-2">`;
            ['S','M','T','W','T','F','S'].forEach(d => calHtml += `<div>${d}</div>`);
            calHtml += `</div><div class="grid grid-cols-7 gap-1">`;
            for (let i = 0; i < firstDay; i++) calHtml += `<div></div>`;
            for (let i = 1; i <= daysInMonth; i++) {
                const dStr = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
                const done = habit.history.includes(dStr);
                calHtml += `<div class="aspect-square rounded flex items-center justify-center text-xs ${done ? 'bg-primary text-white font-bold' : 'bg-appBg border border-primary/10 text-textMuted'}">${i}</div>`;
            }
            calHtml += `</div>`;

            content.innerHTML = `
                <div class="mb-6">
                    <h2 class="text-3xl font-bold text-white mb-2">${habit.name}</h2>
                    ${habit.desc ? `<div class="bg-primary/10 border border-primary/20 p-4 rounded-2xl text-textMain text-sm leading-relaxed whitespace-pre-wrap">${habit.desc}</div>` : ''}
                </div>

                <div class="grid grid-cols-2 gap-3 mb-6">
                    <div class="bg-appBg p-4 rounded-2xl border border-primary/20 text-center">
                        <div class="text-2xl font-bold">üî• ${getStreak(habit.history)}</div>
                        <div class="text-[10px] text-textMuted uppercase tracking-widest mt-1">Current Streak</div>
                    </div>
                    <div class="bg-appBg p-4 rounded-2xl border border-primary/20 text-center">
                        <div class="text-2xl font-bold">üèÜ ${getLongestStreak(habit.history)}</div>
                        <div class="text-[10px] text-textMuted uppercase tracking-widest mt-1">Best Streak</div>
                    </div>
                </div>

                <div class="bg-appBg p-4 rounded-2xl border border-primary/20">
                    <div class="flex justify-between items-center mb-4">
                        <span class="font-bold text-primary">${monthName} ${currentYear}</span>
                    </div>
                    ${calHtml}
                </div>

                <button onclick="deleteHabit('${habit.id}')" class="w-full mt-8 py-3 rounded-xl text-red-400 text-sm font-medium border border-red-400/20 bg-red-400/5">
                    Delete Habit
                </button>
            `;
        }

        // --- Helper Calculations ---
        function getStreak(history) {
            if (!history.length) return 0;
            let streak = 0;
            let checkDate = new Date();
            const todayStr = getTodayString();
            if (!history.includes(todayStr)) checkDate.setDate(checkDate.getDate() - 1);
            while (true) {
                const dStr = `${checkDate.getFullYear()}-${String(checkDate.getMonth() + 1).padStart(2, '0')}-${String(checkDate.getDate()).padStart(2, '0')}`;
                if (history.includes(dStr)) { streak++; checkDate.setDate(checkDate.getDate() - 1); }
                else break;
            }
            return streak;
        }

        function getLongestStreak(history) {
            if (!history.length) return 0;
            const sorted = [...new Set(history)].sort();
            let max = 0, current = 1;
            for (let i = 1; i < sorted.length; i++) {
                const diff = (new Date(sorted[i]) - new Date(sorted[i-1])) / (1000*60*60*24);
                if (diff === 1) current++;
                else { max = Math.max(max, current); current = 1; }
            }
            return Math.max(max, current);
        }

        function deleteHabit(id) {
            if (confirm("Permanently delete this habit?")) {
                habits = habits.filter(h => h.id !== id);
                closeAllModals();
                renderHabits();
            }
        }

        function openModal(id) {
            document.getElementById('modal-overlay').classList.remove('hidden');
            setTimeout(() => document.getElementById(id).classList.remove('translate-y-full'), 10);
        }

        function closeAllModals() {
            document.querySelectorAll('[id$="-modal"]').forEach(m => m.classList.add('translate-y-full'));
            setTimeout(() => document.getElementById('modal-overlay').classList.add('hidden'), 300);
        }

        renderHabits();
    </script>
</body>
</html>
